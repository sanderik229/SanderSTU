{% extends 'shop/base.html' %}
{% block title %}Заказы — SanderStu{% endblock %}
{% block content %}
<main class="container page-orders">
    <h1>Заказы</h1>
    <div id="ordersList" class="orders-list"></div>
</main>

<script>
function getStatusText(status) {
    const statusMap = {
        'new': 'Новый',
        'paid': 'Оплачен',
        'in_progress': 'В работе',
        'done': 'Выполнен',
        'cancelled': 'Отменен'
    };
    return statusMap[status] || status;
}

function getPaymentStatusText(status) {
    const statusMap = {
        'pending': 'Ожидает оплаты',
        'paid': 'Оплачено',
        'failed': 'Ошибка оплаты'
    };
    return statusMap[status] || status;
}

function loadOrders() {
    console.log('loadOrders called'); // Debug log
    const ordersList = $('#ordersList');
    console.log('ordersList element:', ordersList); // Debug log
    ordersList.innerHTML = '<div class="loading">Загрузка заказов...</div>';
    
    console.log('authHeaders function:', typeof authHeaders); // Debug log
    console.log('authHeaders result:', authHeaders()); // Debug log
    
    fetch('/api/v2/orders/', {
        headers: authHeaders()
    })
    .then(response => {
        console.log('Response status:', response.status); // Debug log
        return response.json();
    })
    .then(data => {
        console.log('Orders data:', data); // Debug log
        if (data.length === 0) {
            ordersList.innerHTML = '<div class="no-orders">У вас пока нет заказов</div>';
            return;
        }
        
        ordersList.innerHTML = data.map(order => {
            console.log('Processing order:', order.id, 'payment_status:', order.payment_status, 'payment_amount:', order.payment_amount); // Debug log
            return `
            <div class="order-card">
                <div class="order-header">
                    <span class="order-id">Заказ #${order.id}</span>
                    <span class="order-status ${order.status}">${getStatusText(order.status)}</span>
                </div>
                <div class="order-details">
                    <p><strong>Тип:</strong> ${order.order_type === 'offer' ? 'Предложение' : 'Персональный заказ'}</p>
                    <p><strong>Описание:</strong> ${order.description || 'Не указано'}</p>
                    <p><strong>Бюджет:</strong> ${order.payment_amount ? order.payment_amount + ' ₽' : (order.budget ? order.budget + ' ₽' : 'Не указан')}</p>
                    <p><strong>Создан:</strong> ${new Date(order.created_at).toLocaleDateString('ru-RU')}</p>
                    <p><strong>Статус оплаты:</strong> ${getPaymentStatusText(order.payment_status)}</p>
                    ${order.payment_status === 'pending' ? `
                        <div class="payment-section">
                            <button class="btn accent" onclick="console.log('Payment button clicked for order', ${order.id}); showPaymentModal(${order.id}, ${order.payment_amount || order.budget || 15000})">
                                Оплатить заказ
                            </button>
                        </div>
                    ` : order.payment_status === 'paid' ? `
                        <div class="payment-status paid">
                            <span class="payment-icon">✓</span>
                            <span>Оплачено</span>
                        </div>
                    ` : ''}
                </div>
            </div>
            `;
        }).join('');
    })
    .catch(error => {
        console.error('Error loading orders:', error);
        ordersList.innerHTML = '<div class="error">Ошибка загрузки заказов</div>';
    });
}

// Загружаем заказы при загрузке страницы
document.addEventListener('DOMContentLoaded', function() {
    console.log('DOM loaded, checking functions...'); // Debug log
    console.log('authHeaders available:', typeof authHeaders); // Debug log
    console.log('showPaymentModal available:', typeof showPaymentModal); // Debug log
    console.log('$ function available:', typeof $); // Debug log
    loadOrders();
});
</script>

<style>
.loading, .no-orders, .error {
    text-align: center;
    padding: 40px;
    color: var(--muted);
}

.payment-section {
    margin-top: 16px;
    padding-top: 16px;
    border-top: 1px solid var(--border);
}

.payment-status {
    display: flex;
    align-items: center;
    gap: 8px;
    margin-top: 16px;
    padding: 8px 12px;
    border-radius: 8px;
    font-weight: 500;
}

.payment-status.paid {
    background: #dcfce7;
    color: #166534;
}

.payment-icon {
    font-size: 16px;
    font-weight: bold;
}
</style>
{% endblock %}
