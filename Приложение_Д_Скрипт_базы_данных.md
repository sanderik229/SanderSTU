# Приложение Д: Скрипт базы данных

## Описание

Данный документ содержит SQL-скрипты для создания базы данных системы SanderStu.

**Система управления базой данных:** PostgreSQL 15  
**ORM:** Django 5.2.6  
**Кодировка:** UTF-8

---

## 1. Создание базы данных

```sql
-- Создание базы данных
CREATE DATABASE sanderstu
    WITH 
    OWNER = postgres
    ENCODING = 'UTF8'
    LC_COLLATE = 'en_US.UTF-8'
    LC_CTYPE = 'en_US.UTF-8'
    TABLESPACE = pg_default
    CONNECTION LIMIT = -1;

-- Подключение к базе данных
\c sanderstu;
```

---

## 2. Создание таблиц

### 2.1. Таблица: auth_user (Django системная)

```sql
-- Учетные записи пользователей
CREATE TABLE auth_user (
    id SERIAL PRIMARY KEY,
    username VARCHAR(150) UNIQUE NOT NULL,
    email VARCHAR(254) NOT NULL,
    password VARCHAR(128) NOT NULL,
    first_name VARCHAR(150) DEFAULT '',
    last_name VARCHAR(150) DEFAULT '',
    is_staff BOOLEAN DEFAULT FALSE,
    is_superuser BOOLEAN DEFAULT FALSE,
    is_active BOOLEAN DEFAULT TRUE,
    date_joined TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP
);

-- Индексы
CREATE INDEX idx_auth_user_username ON auth_user(username);
CREATE INDEX idx_auth_user_email ON auth_user(email);

COMMENT ON TABLE auth_user IS 'Системная таблица Django для хранения пользователей';
```

### 2.2. Таблица: accounts_profile

```sql
-- Профили пользователей
CREATE TABLE accounts_profile (
    id SERIAL PRIMARY KEY,
    user_id INTEGER UNIQUE NOT NULL REFERENCES auth_user(id) ON DELETE CASCADE,
    full_name VARCHAR(200) NOT NULL,
    birth_year INTEGER CHECK (birth_year >= 1900 AND birth_year <= 2100),
    role VARCHAR(20) DEFAULT 'user' CHECK (role IN ('user', 'admin', 'manager')),
    card_last4 VARCHAR(4) DEFAULT ''
);

CREATE INDEX idx_accounts_profile_user_id ON accounts_profile(user_id);
CREATE INDEX idx_accounts_profile_role ON accounts_profile(role);

COMMENT ON TABLE accounts_profile IS 'Расширенный профиль пользователя';
```

### 2.3. Таблица: managers_manager

```sql
-- Менеджеры системы
CREATE TABLE managers_manager (
    id SERIAL PRIMARY KEY,
    user_id INTEGER UNIQUE NOT NULL REFERENCES auth_user(id) ON DELETE CASCADE,
    phone VARCHAR(20) DEFAULT '',
    department VARCHAR(100) DEFAULT '',
    hire_date DATE NOT NULL DEFAULT CURRENT_DATE,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_managers_manager_user_id ON managers_manager(user_id);
CREATE INDEX idx_managers_manager_is_active ON managers_manager(is_active);

COMMENT ON TABLE managers_manager IS 'Менеджеры системы с расширенной информацией';
```

### 2.4. Таблица: bloggers_blogger

```sql
-- Блоггеры
CREATE TABLE bloggers_blogger (
    id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    social_network VARCHAR(30) NOT NULL CHECK (social_network IN ('instagram', 'tiktok', 'youtube', 'vk', 'telegram')),
    topic VARCHAR(120) NOT NULL,
    audience_size INTEGER NOT NULL DEFAULT 0 CHECK (audience_size >= 0),
    manager_id INTEGER REFERENCES managers_manager(id) ON DELETE SET NULL
);

CREATE INDEX idx_bloggers_blogger_network ON bloggers_blogger(social_network);
CREATE INDEX idx_bloggers_blogger_manager ON bloggers_blogger(manager_id);

COMMENT ON TABLE bloggers_blogger IS 'Блоггеры, которые продают рекламу';
```

### 2.5. Таблица: bloggers_adoffer

```sql
-- Рекламные предложения блоггеров
CREATE TABLE bloggers_adoffer (
    id SERIAL PRIMARY KEY,
    blogger_id INTEGER REFERENCES bloggers_blogger(id) ON DELETE CASCADE,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    price DECIMAL(10,2) NOT NULL CHECK (price >= 0),
    social_network VARCHAR(30) NOT NULL CHECK (social_network IN ('instagram', 'tiktok', 'youtube', 'vk', 'telegram')),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_adoffer_blogger_id ON bloggers_adoffer(blogger_id);
CREATE INDEX idx_adoffer_is_active ON bloggers_adoffer(is_active);
CREATE INDEX idx_adoffer_price ON bloggers_adoffer(price);

COMMENT ON TABLE bloggers_adoffer IS 'Рекламные предложения блоггеров';
```

### 2.6. Таблица: managers_adservice

```sql
-- Рекламные услуги, созданные менеджерами
CREATE TABLE managers_adservice (
    id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    social_network VARCHAR(20) NOT NULL,
    price DECIMAL(10,2) NOT NULL CHECK (price >= 0),
    description TEXT NOT NULL,
    blogger_id INTEGER NOT NULL REFERENCES bloggers_blogger(id) ON DELETE CASCADE,
    manager_id INTEGER NOT NULL REFERENCES managers_manager(id) ON DELETE CASCADE,
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_adservice_blogger_manager ON managers_adservice(blogger_id, manager_id);
CREATE INDEX idx_adservice_is_active ON managers_adservice(is_active);

COMMENT ON TABLE managers_adservice IS 'Рекламные услуги, созданные менеджерами';
```

### 2.7. Таблица: ads_order

```sql
-- Заказы пользователей
CREATE TABLE ads_order (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES auth_user(id) ON DELETE CASCADE,
    offer_id INTEGER REFERENCES bloggers_adoffer(id) ON DELETE PROTECT,
    order_type VARCHAR(20) DEFAULT 'personal' CHECK (order_type IN ('offer', 'personal')),
    status VARCHAR(20) DEFAULT 'new' CHECK (status IN ('new', 'paid', 'in_progress', 'done', 'cancelled')),
    payment_status VARCHAR(20) DEFAULT 'pending' CHECK (payment_status IN ('pending', 'paid', 'failed')),
    payment_amount DECIMAL(10,2) CHECK (payment_amount >= 0),
    payment_date TIMESTAMP,
    performance JSONB DEFAULT '{}',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    full_name VARCHAR(200),
    email VARCHAR(255),
    phone VARCHAR(40),
    ad_type VARCHAR(50),
    budget DECIMAL(10,2) CHECK (budget >= 0),
    description TEXT,
    deadline INTEGER CHECK (deadline > 0),
    requirements TEXT
);

CREATE INDEX idx_ads_order_user_id ON ads_order(user_id);
CREATE INDEX idx_ads_order_offer_id ON ads_order(offer_id);
CREATE INDEX idx_ads_order_status ON ads_order(status);
CREATE INDEX idx_ads_order_created_at ON ads_order(created_at);

COMMENT ON TABLE ads_order IS 'Заказы пользователей на рекламу';
```

### 2.8. Таблица: managers_managerorder

```sql
-- Заказы под управлением менеджеров
CREATE TABLE managers_managerorder (
    id SERIAL PRIMARY KEY,
    manager_id INTEGER NOT NULL REFERENCES managers_manager(id) ON DELETE CASCADE,
    order_type VARCHAR(20) DEFAULT 'blogger' CHECK (order_type IN ('blogger', 'personal')),
    status VARCHAR(20) DEFAULT 'new' CHECK (status IN ('new', 'accepted', 'in_progress', 'completed', 'cancelled')),
    blogger_order_id INTEGER REFERENCES ads_order(id) ON DELETE CASCADE,
    client_name VARCHAR(200),
    client_email VARCHAR(255),
    client_phone VARCHAR(20),
    service_description TEXT,
    budget DECIMAL(10,2) CHECK (budget >= 0),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_managerorder_manager_id ON managers_managerorder(manager_id);
CREATE INDEX idx_managerorder_status ON managers_managerorder(status);
CREATE INDEX idx_managerorder_created_at ON managers_managerorder(created_at);

COMMENT ON TABLE managers_managerorder IS 'Заказы под управлением менеджеров';
```

### 2.9. Таблица: shop_category

```sql
-- Категории рекламы
CREATE TABLE shop_category (
    id SERIAL PRIMARY KEY,
    name VARCHAR(120) UNIQUE NOT NULL,
    slug VARCHAR(140) UNIQUE NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE UNIQUE INDEX idx_shop_category_name ON shop_category(name);
CREATE UNIQUE INDEX idx_shop_category_slug ON shop_category(slug);

COMMENT ON TABLE shop_category IS 'Категории рекламы';
```

### 2.10. Таблица: shop_ad

```sql
-- Рекламные объявления
CREATE TABLE shop_ad (
    id SERIAL PRIMARY KEY,
    title VARCHAR(200) NOT NULL,
    description TEXT,
    category_id INTEGER NOT NULL REFERENCES shop_category(id) ON DELETE PROTECT,
    price DECIMAL(10,2) NOT NULL CHECK (price >= 0),
    popularity INTEGER DEFAULT 0 CHECK (popularity >= 0),
    image VARCHAR(200),
    is_active BOOLEAN DEFAULT TRUE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_shop_ad_category ON shop_ad(category_id);
CREATE INDEX idx_shop_ad_is_active ON shop_ad(is_active);
CREATE INDEX idx_shop_ad_popularity_price ON shop_ad(popularity DESC, price ASC);

COMMENT ON TABLE shop_ad IS 'Рекламные объявления в магазине';
```

### 2.11. Таблица: reviews_review

```sql
-- Отзывы о блоггерах
CREATE TABLE reviews_review (
    id SERIAL PRIMARY KEY,
    user_id INTEGER NOT NULL REFERENCES auth_user(id) ON DELETE CASCADE,
    blogger_id INTEGER NOT NULL REFERENCES bloggers_blogger(id) ON DELETE CASCADE,
    offer_id INTEGER REFERENCES bloggers_adoffer(id) ON DELETE SET NULL,
    rating SMALLINT DEFAULT 5 CHECK (rating >= 1 AND rating <= 5),
    text TEXT NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_review_user_id ON reviews_review(user_id);
CREATE INDEX idx_review_blogger_id ON reviews_review(blogger_id);
CREATE INDEX idx_review_rating ON reviews_review(rating);

COMMENT ON TABLE reviews_review IS 'Отзывы пользователей о блоггерах';
```

### 2.12. Таблица: managers_weeklyreport

```sql
-- Еженедельные отчеты
CREATE TABLE managers_weeklyreport (
    id SERIAL PRIMARY KEY,
    manager_id INTEGER NOT NULL REFERENCES managers_manager(id) ON DELETE CASCADE,
    week_start DATE NOT NULL,
    week_end DATE NOT NULL,
    total_orders INTEGER DEFAULT 0 CHECK (total_orders >= 0),
    total_revenue DECIMAL(12,2) DEFAULT 0 CHECK (total_revenue >= 0),
    active_services INTEGER DEFAULT 0 CHECK (active_services >= 0),
    pdf_file VARCHAR(200),
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT check_week_end_after_start CHECK (week_end >= week_start)
);

CREATE INDEX idx_weeklyreport_manager_id ON managers_weeklyreport(manager_id);
CREATE INDEX idx_weeklyreport_week_start ON managers_weeklyreport(week_start DESC);

COMMENT ON TABLE managers_weeklyreport IS 'Еженедельные отчеты менеджеров';
```

### 2.13. Таблица: managers_notification

```sql
-- Уведомления для менеджеров
CREATE TABLE managers_notification (
    id SERIAL PRIMARY KEY,
    manager_id INTEGER NOT NULL REFERENCES managers_manager(id) ON DELETE CASCADE,
    notification_type VARCHAR(20) NOT NULL CHECK (notification_type IN ('service_created', 'service_updated', 'service_deleted', 'order_accepted', 'order_completed', 'report_generated')),
    title VARCHAR(200) NOT NULL,
    message TEXT NOT NULL,
    is_read BOOLEAN DEFAULT FALSE,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_notification_manager_id ON managers_notification(manager_id);
CREATE INDEX idx_notification_is_read ON managers_notification(is_read);
CREATE INDEX idx_notification_created_at ON managers_notification(created_at DESC);

COMMENT ON TABLE managers_notification IS 'Уведомления для менеджеров';
```

---

## 3. Вставка тестовых данных

```sql
-- Вставка тестовых пользователей
INSERT INTO auth_user (username, email, password, first_name, last_name, is_staff, is_superuser, is_active) VALUES
('admin@gmail.com', 'admin@gmail.com', 'pbkdf2_sha256$600000$...', 'Admin', 'User', TRUE, TRUE, TRUE),
('manager@gmail.com', 'manager@gmail.com', 'pbkdf2_sha256$600000$...', 'Manager', 'User', FALSE, FALSE, TRUE),
('user@gmail.com', 'user@gmail.com', 'pbkdf2_sha256$600000$...', 'Test', 'User', FALSE, FALSE, TRUE);

-- Вставка профилей
INSERT INTO accounts_profile (user_id, full_name, role) VALUES
(1, 'Admin User', 'admin'),
(2, 'Manager User', 'manager'),
(3, 'Test User', 'user');

-- Вставка категорий
INSERT INTO shop_category (name, slug) VALUES
('Баннеры', 'banners'),
('Соцсети', 'social'),
('Email', 'email');

-- Вставка рекламы
INSERT INTO shop_ad (title, description, category_id, price, popularity, is_active) VALUES
('Баннер на главной', 'Размещение баннера 728x90', 1, 15000.00, 95, TRUE),
('Пост в Instagram', 'Нативная интеграция', 2, 12000.00, 88, TRUE),
('Email рассылка', 'Баннер в рассылке', 3, 9000.00, 72, TRUE);

-- Вставка блоггеров
INSERT INTO bloggers_blogger (name, social_network, topic, audience_size, manager_id) VALUES
('@blogger_name', 'instagram', 'Travel', 150000, 1),
('@tech_review', 'youtube', 'Tech', 500000, 1),
('@fashion_blog', 'tiktok', 'Fashion', 300000, 1);

-- Вставка предложений
INSERT INTO bloggers_adoffer (blogger_id, title, description, price, social_network, is_active) VALUES
(1, 'Story реклама в Instagram', 'Размещение рекламы в stories', 15000.00, 'instagram', TRUE),
(2, 'Обзор продукта', 'Видео обзор продукции', 50000.00, 'youtube', TRUE),
(3, 'TikTok интеграция', 'Нативная реклама в виде', 25000.00, 'tiktok', TRUE);
```

---

## 4. Полезные SQL-запросы

### 4.1. Статистика по заказам

```sql
-- Список всех заказов с информацией о пользователе
SELECT 
    o.id,
    o.status,
    o.payment_status,
    o.payment_amount,
    u.username,
    p.full_name
FROM ads_order o
LEFT JOIN auth_user u ON o.user_id = u.id
LEFT JOIN accounts_profile p ON u.id = p.user_id
ORDER BY o.created_at DESC;
```

### 4.2. Заказы менеджера

```sql
-- Все заказы конкретного менеджера
SELECT 
    mo.id,
    mo.order_type,
    mo.status,
    mo.client_name,
    mo.budget,
    u.email AS manager_email
FROM managers_managerorder mo
JOIN managers_manager m ON mo.manager_id = m.id
JOIN auth_user u ON m.user_id = u.id
WHERE mo.manager_id = 1;
```

### 4.3. Популярные блоггеры

```sql
-- ТОП-5 блоггеров по размеру аудитории
SELECT 
    name,
    social_network,
    topic,
    audience_size
FROM bloggers_blogger
ORDER BY audience_size DESC
LIMIT 5;
```

### 4.4. Выручка менеджера

```sql
-- Общая выручка менеджера
SELECT 
    m.id AS manager_id,
    u.email AS manager_email,
    COUNT(mo.id) AS total_orders,
    SUM(mo.budget) AS total_revenue
FROM managers_manager m
JOIN auth_user u ON m.user_id = u.id
LEFT JOIN managers_managerorder mo ON mo.manager_id = m.id
WHERE mo.status = 'completed'
GROUP BY m.id, u.email;
```

### 4.5. Активные предложения

```sql
-- Все активные предложения с информацией о блоггере
SELECT 
    ao.id,
    ao.title,
    ao.price,
    ao.social_network,
    b.name AS blogger_name,
    b.audience_size
FROM bloggers_adoffer ao
JOIN bloggers_blogger b ON ao.blogger_id = b.id
WHERE ao.is_active = TRUE
ORDER BY ao.price ASC;
```

---

## 5. Операции резервного копирования и восстановления

### 5.1. Создание бэкапа

```sql
-- Создание полного бэкапа базы данных
pg_dump -U postgres -d sanderstu -F c -f sanderstu_backup.dump

-- Создание SQL-скрипта бэкапа
pg_dump -U postgres -d sanderstu > sanderstu_backup.sql
```

### 5.2. Восстановление из бэкапа

```sql
-- Восстановление из dump-файла
pg_restore -U postgres -d sanderstu sanderstu_backup.dump

-- Восстановление из SQL-файла
psql -U postgres -d sanderstu < sanderstu_backup.sql
```

### 5.3. Очистка базы данных

```sql
-- Удаление всех данных (НЕ удаляет структуру таблиц)
TRUNCATE TABLE 
    managers_notification,
    managers_weeklyreport,
    managers_managerorder,
    managers_adservice,
    accounts_profile,
    reviews_review,
    shop_ad,
    shop_category,
    ads_order,
    bloggers_adoffer,
    bloggers_blogger,
    managers_manager,
    auth_user
CASCADE;
```

---

## 6. Миграции Django

Для применения миграций в Django используйте:

```bash
# Создание миграций
python manage.py makemigrations

# Применение миграций
python manage.py migrate

# Откат миграций
python manage.py migrate app_name migration_number
```

---

**Примечание:**  
- Все внешние ключи имеют каскадные связи для автоматического удаления зависимых записей
- Все денежные поля используют тип DECIMAL(10,2) для точности расчетов
- Все даты используют TIMESTAMP для отслеживания изменений
- Индексы оптимизированы для частых запросов поиска и сортировки

**База данных:** PostgreSQL 15  
**Кодировка:** UTF-8  
**Стиль кодирования:** Snake_case для таблиц и полей

